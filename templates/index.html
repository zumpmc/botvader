<!DOCTYPE html>
<html>
<head>
  <title>death-star-farm - dashboard</title>
  <style>
    body { font-family: monospace; background: #0d1117; color: #c9d1d9; margin: 0; padding: 2rem; }
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; }
    h1 { margin: 0; color: #58a6ff; font-size: 1.4rem; }
    .nav { display: flex; gap: 1rem; }
    a.logout { color: #8b949e; text-decoration: none; }
    a.logout:hover { color: #c9d1d9; }
    .section-title { color: #8b949e; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.05em; margin: 1.5rem 0 0.8rem; }
    .feeds { display: flex; flex-direction: column; gap: 1rem; max-width: 600px; }
    .feed { background: #161b22; border: 1px solid #30363d; border-radius: 8px; padding: 1rem 1.5rem; display: flex; justify-content: space-between; align-items: center; }
    .feed-info { flex: 1; }
    .feed-name { font-size: 1.1rem; font-weight: bold; margin-bottom: 0.3rem; }
    .feed-health { font-size: 0.85rem; color: #8b949e; }
    .feed-link { color: #58a6ff; text-decoration: none; }
    .feed-link:hover { text-decoration: underline; }
    .status { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 6px; }
    .status-ok { background: #3fb950; }
    .status-degraded { background: #d29922; }
    .status-down { background: #f85149; }
    .status-stopped { background: #484f58; }
    .btn { padding: 0.4rem 1rem; border: none; border-radius: 4px; cursor: pointer; font-family: monospace; font-size: 0.9rem; }
    .btn-start { background: #238636; color: #fff; }
    .btn-start:hover { background: #2ea043; }
    .btn-stop { background: #da3633; color: #fff; }
    .btn-stop:hover { background: #f85149; }
  </style>
</head>
<body>
  <div class="header">
    <h1>death-star-farm</h1>
    <div class="nav">
      <a class="logout" href="/storage">storage</a>
      <a class="logout" href="/debug">debug</a>
      <a class="logout" href="/logout">logout</a>
    </div>
  </div>
  <div class="section-title">feed managers</div>
  <div class="feeds" id="managers">Loading...</div>
  <script>
    async function loadAll() {
      var res = await fetch('/api/managers');
      if (res.status === 401 || res.redirected) { window.location = '/login'; return; }
      var managers = await res.json();
      renderCards(document.getElementById('managers'), managers);
    }

    function renderCards(container, items) {
      container.innerHTML = '';
      items.forEach(function(f) {
        var div = document.createElement('div');
        div.className = 'feed';
        var statusClass = 'status-' + f.health.status;
        var msg = f.health.message ? ' \u2014 ' + f.health.message : '';
        var linkHref = '/manager/' + f.name;
        var nameHtml = '<a href="' + linkHref + '" class="feed-link">' + f.name + '</a>';
        div.innerHTML =
          '<div class="feed-info">' +
            '<div class="feed-name"><span class="status ' + statusClass + '"></span>' + nameHtml + '</div>' +
            '<div class="feed-health">' + f.health.status + msg + '</div>' +
          '</div>' +
          '<button class="btn ' + (f.running ? 'btn-stop' : 'btn-start') + '"' +
          ' onclick="toggle(\'' + f.name + '\', ' + f.running + ')">' +
          (f.running ? 'Stop' : 'Start') + '</button>';
        container.appendChild(div);
      });
    }

    async function toggle(name, running) {
      var action = running ? 'stop' : 'start';
      await fetch('/api/managers/' + name + '/' + action, { method: 'POST' });
      loadAll();
    }

    loadAll();
    setInterval(loadAll, 3000);
  </script>
</body>
</html>
